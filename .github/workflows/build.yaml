name: RootHub Manage Hub CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  schedule:
    - cron: '*/8 * * * *'

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false                # don't cancel other matrix jobs if one fails
      max-parallel: 4
      matrix:
        python-version: [3.8, 3.9, 3.10, 3.11]  # remove EOL/experimental versions

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug — runner info
        run: |
          uname -a
          lsb_release -a || true
          echo "GITHUB_RUN_ID=$GITHUB_RUN_ID"
          echo "Matrix python: ${{ matrix.python-version }}"

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Show python
        run: |
          which python
          python --version
          python -m pip --version

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Django Tests
        run: |
          python manage.py test

      - name: Deploy to Render (after tests pass)
        if: github.ref == 'refs/heads/master'
        env:
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          echo "Triggering Render deployment..."
          curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Accept: application/json" \
            -H "Authorization: Bearer $RENDER_API_KEY"
          echo "✅ Render deployment triggered successfully!"

  wake_render:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Wake Render (ping service URL stored in secret)
        env:
          RENDER_PING_URL: ${{ secrets.RENDER_PING_URL }}
        run: |
          set -e
          if [ -z "${RENDER_PING_URL}" ]; then
            echo "ERROR: RENDER_PING_URL secret is not set"; exit 1
          fi
          echo "Pinging Render service to keep it awake..."
          for i in 1 2 3; do
            if curl --fail --silent --show-error --max-time 10 "${RENDER_PING_URL}"; then
              echo "Ping successful (attempt $i)"; exit 0
            else
              echo "Ping attempt $i failed; retrying..."
              sleep 2
            fi
          done
          echo "All ping attempts failed"; exit 1