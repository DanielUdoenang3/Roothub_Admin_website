{% extends "base.html" %}
{% load static %}

{% block main_content %}
{% if request.user.user_type == "1" %}
<div class="page-header mb-4">
    <div class="row align-items-center">
        <div class="col">
            <h3 class="page-title"><i class="fas fa-user-edit me-2 text-primary"></i>Edit Trainee: <span class="text-dark">{{ trainee.trainee_name.first_name|capfirst }} {{ trainee.trainee_name.last_name|capfirst }}</span></h3>
            <ul class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'view_trainee' %}"><i class="fas fa-users me-1"></i>Trainees</a></li>
                <li class="breadcrumb-item active">Edit / {{ trainee.trainee_name.username|capfirst }}</li>
            </ul>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-sm-12">
        <div class="card shadow-lg border-0">
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    {% include "includes/messages.html" %}
                    <div class="row">
                        <!-- Personal Details -->
                        <div class="col-12">
                            <h5 class="form-title"><span>Personal Details</span></h5>
                        </div>
                        <div class="col-12 col-sm-4">
                            <div class="form-group local-forms">
                                <label>First Name </label>
                                <input type="text" class="form-control" name="first_name" value="{{ trainee.trainee_name.first_name|capfirst }}">
                            </div>
                        </div>
                        <div class="col-12 col-sm-4">
                            <div class="form-group local-forms">
                                <label>Middle Name</label>
                                <input type="text" class="form-control" name="middle_name" value="{{ trainee.trainee_name.middle_name|capfirst }}">
                            </div>
                        </div>
                        <div class="col-12 col-sm-4">
                            <div class="form-group local-forms">
                                <label>Last Name</label>
                                <input type="text" class="form-control" name="last_name" value="{{ trainee.trainee_name.last_name|capfirst }}">
                            </div>
                        </div>
                        <div class="col-12 col-sm-4">
                            <div class="form-group local-forms">
                                <label>Gender </label>
                                <select class="form-control form-select" name="gender">
                                    <option disabled>Select Gender</option>
                                    <option value="Male" {% if trainee.gender == 'Male' %}selected{% endif %}>Male</option>
                                    <option value="Female" {% if trainee.gender == "Female" %}selected{% endif %}>Female</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-12 col-sm-4">
                            <div class="form-group local-forms">
                                <label>Mobile </label>
                                <input type="text" class="form-control" name="phone" value="{{ trainee.phone }}">
                            </div>
                        </div>
                        <div class="col-12 col-sm-4">
                            <div class="form-group local-forms">
                                <label>Trainee Category</label>
                                <select name="category" class="form-control form-select">
                                    <option value="" disabled>Select Trainee Category</option>
                                    {% for cat, cat_label in trainee.TRAINEE_CATEGORIES %}
                                    <option value="{{ cat }}" {% if trainee.category == cat %}selected{% endif %}>{{ cat_label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-12 col-sm-4">
                            <div class="form-group local-forms">
                                <label>Username </label>
                                <input type="text" class="form-control" name="username" value="{{ trainee.trainee_name.username|capfirst }}">
                            </div>
                        </div>
                        <div class="col-12 col-sm-4">
                            <div class="form-group local-forms">
                                <label>Email</label>
                                <input type="email" class="form-control" name="email" value="{{ trainee.trainee_name.email }}">
                            </div>
                        </div>
                        <center>
                            <div class="col-12 col-sm-6">
                                <div class="form-group students-up-files">
                                    <label>Current Profile Picture</label>
                                    <div class="uplod">
                                        <img src="{{ trainee.trainee_name.profile_pic.url }}" alt="Profile Picture" class="img-thumbnail" width="150px" height="150px">
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-group students-up-files">
                                    <label>Upload New Profile Picture (150px X 150px)</label>
                                    <div class="uplod">
                                        <label class="file-upload image-upbtn mb-0">
                                            <i class="fas fa-upload me-2"></i>Choose File <input type="file" accept="image/*" name="profile_pic">
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </center>
                        <!-- SIWES Details -->
                        <div class="col-12" id="select-siwes-head" style="display:none;">
                            <h5 class="form-title"><span>SIWES Details</span></h5>
                        </div>
                        <div class="col-12 col-sm-7" id="select-siwes-intern" style="display:none;">
                            <div class="form-group local-forms">
                                <label>Name of School</label>
                                <input type="text" class="form-control" name="school_name" value="{{ trainee.name_of_school }}">
                            </div>
                        </div>
                        <div class="col-12 col-sm-5" id="select-siwes-intern2" style="display:none;">
                            <div class="form-group local-forms">
                                <label>Course of Study</label>
                                <input type="text" class="form-control" name="course_of_study" value="{{ trainee.course_of_study }}">
                            </div>
                        </div>
                        <div class="col-12 col-sm-6" id="select-siwes-intern3" style="display:none;">
                            <div class="form-group local-forms">
                                <label>Matric Number</label>
                                <input type="text" class="form-control" name="matric_number" value="{{ trainee.matric_number }}">
                            </div>
                        </div>
                        <div class="col-12 col-sm-5" id="select-siwes-intern4" style="display:none;">
                            <div class="form-group local-forms">
                                <label>Duration of Internship</label>
                                <input type="text" class="form-control" name="internship_duration" value="{{ trainee.duration_of_intership }}">
                            </div>
                        </div>
                        <!-- Address -->
                        <div class="col-12">
                            <h5 class="form-title"><span>Address</span></h5>
                        </div>
                        <div class="col-12 col-sm-4">
                            <div class="form-group local-forms">
                                <label>City </label>
                                <input type="text" class="form-control" name="city" value="{{ trainee.city }}">
                            </div>
                        </div>
                        <div class="col-12 col-sm-4">
                            <div class="form-group local-forms">
                                <label>State </label>
                                <input type="text" class="form-control" name="state" value="{{ trainee.state }}">
                            </div>
                        </div>
                        <div class="col-12 col-sm-4">
                            <div class="form-group local-forms">
                                <label>Country </label>
                                <input type="text" class="form-control" name="country" value="{{ trainee.country }}">
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="form-group local-forms">
                                <label>Address</label>
                                <textarea class="form-control" name="address" rows="3">{{ trainee.address }}</textarea>
                            </div>
                        </div>
                        <!-- Course and Payment -->
                        <div class="col-12">
                            <h5 class="form-title"><span>Course and Payment Option Selection</span></h5>
                        </div>
                        <div class="col-12 col-sm-8">
                            <div class="form-group local-forms">
                                <label>Select a Course</label>
                                <select name="course" class="form-control form-select" required>
                                    <option value="" disabled>Select a Course you would love to Study</option>
                                    {% for course in courses %}
                                    <option value="{{ course.id }}"{% if trainee.course_id.id == course.id %}selected{% endif %}>{{ course.course_name }}  ------  {{ course.price }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-12 col-sm-8">
                            <div class="form-group local-forms">
                                <label>Course Portion</label>
                                <select name="portion_type" id="portion_type" class="form-control form-select" required>
                                    <option value="Full Course" {% if trainee.portion_type == "Full Course" %}selected{% endif %}>Full Course</option>
                                    <option value="Level" {% if trainee.portion_type == "Level" %}selected{% endif %}>Specific Level(s)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-12 col-sm-8" id="portion-value-section" style="display:none;">
                            <div class="form-group" id="portion-value-container" name="portion_value_container">
                                <!-- Content will be injected by JS -->
                            </div>
                        </div>
                        <div class="col-12 col-sm-8">
                            <div class="form-group local-forms">
                                <label>Payment Option</label>
                                <select name="payment" class="form-control form-select" required>
                                    <option value="" disabled>Select Payment Option</option>
                                    {% for opt, opt_label in trainee.PAYMENT_OPTION %}
                                    <option value="{{ opt }}" {% if trainee.payment_option == opt %}selected{% endif %}>{{ opt_label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="form-group local-forms">
                                <label>Amount Paid</label>
                                <input type="number" name="amount_paid" class="form-control" value="{{ trainee.paymenthistory_id.amount_paid }}">
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="form-group local-forms">
                                <label>Date of Payment</label>
                                <input type="date" name="date_of_payment" class="form-control" value="{{ trainee.paymenthistory_id.payment_date|date:'Y-m-d' }}">
                            </div>
                        </div>

                        <div class="col-12 col-sm-5">
                            <div class="form-group local-forms">
                                <label>Payment Method</label>
                                <select name="payment_method" class="form-control form-select" required>
                                    <option value="" disabled selected>Select Payment Method</option>
                                    <option {% if trainee.paymenthistory_id.payment_method == 'Cash' %}selected{% endif %}>Cash</option>
                                    <option {% if trainee.paymenthistory_id.payment_method == 'Bank Transfer' %}selected{% endif %}>Bank Transfer</option>
                                    <option {% if trainee.paymenthistory_id.payment_method == 'Card' %}selected{% endif %}>Card</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-12 col-sm-5" id="installment-section" style="display:none;">
                            <div class="form-group local-forms">
                                <label>Installmental Payment</label>
                                <select name="installmental_payment" id="installmental_payment" class="form-control form-select">
                                    <option value="" disabled selected>Select Installment</option>
                                    <!-- Options will be populated by JS -->
                                </select>
                            </div>
                        </div>

                        <div class="col-12 col-sm-6" id="due-date-section" style="display:none;">
                            <div class="form-group local-forms">
                                <label>Due Date for Remaining 30%</label>
                                <input type="date" name="due_date_30" class="form-control" placeholder="Select Due Date" value="{{ trainee.paymenthistory_id.upfront_due_date|date:'Y-m-d' }}">
                                <span class="fw-bold text-danger"><small id="remaining-amount-info" name="upfront_due_date" class="form-text text-muted"></small></span>
                            </div>
                        </div>

                        <div class="col-12 col-sm-7">
                            <div class="form-group local-forms">
                                <label>Commencement Date</label>
                                <input type="date" class="form-control" name="commencement_date" value="{{ trainee.commencement_date|date:'Y-m-d' }}">
                            </div>
                        </div>
                        <!-- Next of Kin -->
                        <div class="col-12">
                            <h5 class="form-title"><span>Next of Kin</span></h5>
                        </div>
                        <div class="col-12 col-sm-4">
                            <div class="form-group local-forms">
                                <label>First Name</label>
                                <input type="text" name="next_first_name" class="form-control" value="{{ trainee.nok_first_name }}">
                            </div>
                        </div>
                        <div class="col-12 col-sm-4">
                            <div class="form-group local-forms">
                                <label>Last Name</label>
                                <input type="text" name="next_last_name" class="form-control" value="{{ trainee.nok_last_name }}">
                            </div>
                        </div>
                        <div class="col-12 col-sm-4">
                            <div class="form-group local-forms">
                                <label>Email</label>
                                <input type="email" name="next_email" class="form-control" value="{{ trainee.nok_email }}">
                            </div>
                        </div>
                        <div class="col-12 col-sm-5">
                            <div class="form-group local-forms">
                                <label>Phone</label>
                                <input type="text" name="next_phone" class="form-control" value="{{ trainee.nok_phone }}">
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="form-group local-forms">
                                <label>Relation</label>
                                <input type="text" name="relation" class="form-control" value="{{ trainee.nok_relationship }}">
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="student-submit">
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const courseSelect = document.querySelector('select[name="course"]');
    const paymentSelect = document.querySelector('select[name="payment"]');
    const paymentMethodSelect = document.querySelector('select[name="payment_method"]');
    const amountPaidInput = document.querySelector('input[name="amount_paid"]');
    const installmentSection = document.getElementById('installment-section');
    const installmentSelect = document.getElementById('installmental_payment');
    const dueDateSection = document.getElementById('due-date-section');
    const remainingAmountInfo = document.getElementById('remaining-amount-info');
    const portionTypeSelect = document.getElementById('portion_type');
    const portionValueSection = document.getElementById('portion-value-section');
    const portionValueContainer = document.getElementById('portion-value-container');

    // Payment info panel (insert if missing)
    let paymentInfo = document.getElementById('payment-info');
    if (!paymentInfo) {
        paymentInfo = document.createElement('div');
        paymentInfo.id = 'payment-info';
        paymentInfo.className = 'alert alert-info mt-3';
        paymentInfo.style.display = 'none';
        const paymentFormGroup = paymentSelect.closest('.form-group');
        if (paymentFormGroup) paymentFormGroup.appendChild(paymentInfo);
    }

    // Course metadata (injected by template)
    let courseData = {};
    {% for course in courses %}
        courseData["{{ course.id }}"] = {
            price: {{ course.price|floatformat:2 }},
            months: {{ course.months|default:1 }}
        };
    {% endfor %}

    // Levels already selected for this trainee (string ids)
    const selectedLevels = [
        {% for lvl in trainee.levels.all %}
            "{{ lvl.id }}",
        {% endfor %}
    ];

    function formatCurrency(amount) {
        return '₦' + Number(amount).toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    function getLevelCheckboxes() {
        return Array.from(portionValueContainer.querySelectorAll('.level-checkbox'));
    }
    function getSelectedLevelsCount() {
        return getLevelCheckboxes().filter(b => b.checked).length;
    }
    function getTotalLevelsCount() {
        return getLevelCheckboxes().length;
    }

    function getSelectedPriceAndMonths() {
        const courseId = courseSelect.value;
        const course = courseData[courseId];
        if (!course) return { price: 0, months: 1 };

        if (portionTypeSelect.value === 'Level') {
            const total = getTotalLevelsCount();
            const selected = getSelectedLevelsCount();
            if (total > 0 && selected > 0) {
                const perLevel = course.price / total;
                return { price: perLevel * selected, months: selected };
            }
            return { price: 0, months: 1 };
        }
        return { price: course.price, months: course.months || 1 };
    }

    function updateInstallmentOptions() {
        const paymentOption = paymentSelect.value;
        const { months } = getSelectedPriceAndMonths();
        installmentSelect.innerHTML = '<option value="" disabled selected>Select Installment</option>';
        installmentSection.style.display = 'none';

        const monthlyOpt = paymentSelect.querySelector('option[value="Monthly Payment"]');
        if (paymentOption === 'Monthly Payment') {
            if (!months || months <= 1) {
                if (monthlyOpt) monthlyOpt.disabled = true;
            } else {
                if (monthlyOpt) monthlyOpt.disabled = false;
                for (let i = 1; i <= months; i++) {
                    let suffix = 'th';
                    if (i === 1) suffix = 'st'; else if (i === 2) suffix = 'nd'; else if (i === 3) suffix = 'rd';
                    installmentSelect.insertAdjacentHTML('beforeend', `<option value="${i}">${i}${suffix} Installment</option>`);
                }
                // pre-select existing installment if available (template may set data-selected)
                const pre = "{{ trainee.paymenthistory_id.installmental_payment|default_if_none:'' }}";
                if (pre) {
                    setTimeout(()=> { installmentSelect.value = pre; }, 50);
                }
                installmentSection.style.display = 'block';
            }
        } else {
            if (monthlyOpt) monthlyOpt.disabled = false;
        }
    }

    function updateDueDateSection() {
        const paymentOption = paymentSelect.value;
        const { price } = getSelectedPriceAndMonths();
        dueDateSection.style.display = 'none';
        remainingAmountInfo.innerHTML = '';

        if (paymentOption !== '70% upfront and 30% later' || price <= 0) return;

        const paid = parseFloat(amountPaidInput.value) || 0;
        const upfront = Math.round(price * 0.7 * 100) / 100;
        const later = Math.round((price - upfront) * 100) / 100;

        let html = `<div><strong>Total:</strong> ${formatCurrency(price)}</div>`;
        html += `<div><strong>Upfront (70%):</strong> ${formatCurrency(upfront)}</div>`;
        html += `<div><strong>Remaining (30%):</strong> ${formatCurrency(later)}</div>`;

        if (paid < upfront) {
            const remUpfront = Math.round((upfront - paid) * 100) / 100;
            html += `<div class="text-danger">Outstanding upfront: ${formatCurrency(remUpfront)}</div>`;
        } else {
            const remaining_total = Math.max(0, Math.round((price - paid) * 100) / 100);
            html += `<div><strong>Remaining to be paid later:</strong> ${formatCurrency(remaining_total)}</div>`;
        }

        remainingAmountInfo.innerHTML = html;
        dueDateSection.style.display = 'block';
    }

    function updatePaymentInfo() {
        const paymentOption = paymentSelect.value;
        const { price, months } = getSelectedPriceAndMonths();
        paymentInfo.innerHTML = '';
        paymentInfo.style.display = 'none';
        if (price <= 0 || !paymentOption) return;

        let html = '';
        if (portionTypeSelect.value === 'Level') {
            const selected = getSelectedLevelsCount();
            const total = getTotalLevelsCount();
            const perLevel = selected ? (price / selected) : 0;
            html += `<div class="mb-2"><span class="badge bg-primary">Level Selection</span></div>`;
            html += `<div><strong>Selected:</strong> ${selected} / ${total}</div>`;
            html += `<div><strong>Price per selected level:</strong> ${formatCurrency(perLevel)}</div>`;
            html += `<div><strong>Total:</strong> ${formatCurrency(price)}</div>`;
        } else {
            html += `<div><strong>Total course price:</strong> ${formatCurrency(price)}</div>`;
        }

        if (paymentOption === 'Full Payment') {
            html += `<div class="mt-2"><strong>Full Payment:</strong> Pay ${formatCurrency(price)} now.</div>`;
        } else if (paymentOption === '70% upfront and 30% later') {
            const upfront = Math.round(price * 0.7 * 100) / 100;
            const later = Math.round((price - upfront) * 100) / 100;
            html += `<div class="mt-2"><strong>70%:</strong> ${formatCurrency(upfront)} — <strong>30%:</strong> ${formatCurrency(later)}</div>`;
        } else if (paymentOption === 'Monthly Payment') {
            const monthly = months ? (price / months) : price;
            html += `<div class="mt-2"><strong>Monthly:</strong> ${formatCurrency(monthly)} per month for ${months} month(s). Total ${formatCurrency(price)}</div>`;
        }

        paymentInfo.innerHTML = html;
        paymentInfo.style.display = 'block';
    }

    function updateLevelRelatedViews() {
        updatePaymentInfo();
        updateInstallmentOptions();
        updateDueDateSection();
    }

    // Build level checkboxes HTML and pre-check trainee's selections
    function renderLevels(levels) {
        if (!levels || levels.length === 0) {
            portionValueContainer.innerHTML = '<label>Select Level(s)</label><div class="text-danger">No levels available for this course.</div>';
            return;
        }
        let html = '<label class="mb-2">Select Level(s)</label>';
        html += '<div class="row" id="levels-checkbox-group">';
        levels.forEach(level => {
            const isChecked = selectedLevels.includes(String(level.id)) ? 'checked' : '';
            html += `
                <div class="col-12 col-md-6 mb-2">
                    <div class="form-check">
                        <input class="form-check-input level-checkbox" type="checkbox" name="portion_value" id="level_${level.id}" value="${level.id}" ${isChecked}>
                        <label class="form-check-label" for="level_${level.id}">${level.name || level.level}</label>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        html += '<small class="form-text text-muted">Select one or more levels, but not all.</small>';
        html += '<div id="level-warning" class="text-danger mt-2" style="display:none;">You cannot select all levels. Please select fewer levels or choose "Full Course".</div>';
        portionValueContainer.innerHTML = html;

        // attach listeners and prevent selecting all
        const checkboxes = portionValueContainer.querySelectorAll('.level-checkbox');
        const warning = portionValueContainer.querySelector('#level-warning');
        checkboxes.forEach(cb => cb.addEventListener('change', function() {
            const checked = Array.from(checkboxes).filter(c => c.checked);
            if (checked.length === checkboxes.length) {
                this.checked = false;
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
            updateLevelRelatedViews();
        }));
        // initial update after rendering
        updateLevelRelatedViews();
    }

    // Load levels via AJAX for a course and render (used on load & when course changes)
    function loadAndRenderLevels(courseId) {
        portionValueContainer.innerHTML = '<label>Select Level(s)</label><div id="level-loading">Loading...</div>';
        fetch(`/ajax/get-levels/?course_id=${courseId}`)
            .then(r => r.json())
            .then(data => {
                renderLevels(data.levels || []);
            })
            .catch(() => {
                portionValueContainer.innerHTML = '<label>Select Level(s)</label><div class="text-danger">Error loading levels.</div>';
            });
    }

    // Listen for changes
    portionTypeSelect.addEventListener('change', function() {
        portionValueSection.style.display = (this.value === 'Level') ? 'block' : 'none';
        portionValueContainer.innerHTML = '';
        if (this.value === 'Level') {
            const c = courseSelect.value;
            if (c) loadAndRenderLevels(c);
            else portionValueContainer.innerHTML = '<label>Select Level(s)</label><div class="text-warning">Please select a course first.</div>';
        } else {
            portionValueContainer.innerHTML = '';
            updateLevelRelatedViews();
        }
    });

    courseSelect.addEventListener('change', function() {
        if (portionTypeSelect.value === 'Level') {
            loadAndRenderLevels(this.value);
        }
        updateLevelRelatedViews();
    });

    paymentSelect.addEventListener('change', updateLevelRelatedViews);
    amountPaidInput.addEventListener('input', updateDueDateSection);

    // Pre-select payment method if provided by server-side (input already has value attr in template)
    const serverPayMethod = "{{ trainee.paymenthistory_id.payment_method|default_if_none:'' }}";
    if (serverPayMethod) paymentMethodSelect.value = serverPayMethod;

    // If page loaded with "Level" preselected, trigger rendering and pre-check boxes
    if (portionTypeSelect.value === 'Level') {
        const currentCourse = courseSelect.value;
        if (currentCourse) loadAndRenderLevels(currentCourse);
        portionValueSection.style.display = 'block';
    } else {
        portionValueSection.style.display = 'none';
    }

    // initial UI updates
    updateInstallmentOptions();
    updateDueDateSection();
    updatePaymentInfo();
});
</script>
{% endif %}
{% endblock main_content %}