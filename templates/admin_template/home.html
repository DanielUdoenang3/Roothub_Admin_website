{% extends "base.html" %}
{% load static %}

{% block main_content %}
{% if request.user.user_type == "1" %}
<div class="page-header">
    <div class="row">
        <div class="col-sm-12">
            <div class="page-sub-header">
                <h3 class="page-title">Welcome {{ user.username|capfirst }}!</h3>
                <ul class="breadcrumb">
                    <li class="breadcrumb-item"><a href="#">Home</a></li>
                    <li class="breadcrumb-item active">Admin Dashboard</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% include "includes/messages.html" %}
<div class="row">
    <div class="col-xl-4 col-sm-4 col-6 d-flex">
        <div class="card bg-comman w-100">
            <div class="card-body">
                <div class="db-widgets d-flex justify-content-between align-items-center">
                    <div class="db-info">
                        {% if trainers > 1 %}
                        <h6> Total Trainers</h6> 
                        {% else %}
                        <h6> Total Trainer</h6>
                        {% endif %}
                        <p>
                            <h3>{{ trainers }}</h3>
                        </p>
                    </div>
                    <div class="db-icon">
                        <i class="fas fa-chalkboard-teacher"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-4 col-sm-4 col-6 d-flex">
        <div class="card bg-comman w-100">
            <div class="card-body">
                <div class="db-widgets d-flex justify-content-between align-items-center">
                    <div class="db-info">
                        
                        {% if trainees > 1 %}
                        <h6> Total Trainees</h6> 
                        {% else %}
                        <h6> Total Trainee</h6>
                        {% endif %}
                        <p>
                            <h3>{{ trainees }}</h3>
                        </p>
                    </div>
                    <div class="db-icon">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-4 col-sm-4 col-6 d-flex">
        <div class="card bg-comman w-100">
            <div class="card-body">
                <div class="db-widgets d-flex justify-content-between align-items-center">
                    <div class="db-info">
                        <h6> Total Courses</h6>
                        <p>
                            <h3>{{ courses }}</h3>
                        </p>
                    </div>
                    <div class="db-icon">
                        <i class="fas fa-layer-group"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12 col-lg-6">
            <div class="card card-chart">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col-6">
                            <h5 class="card-title">Overview</h5>
                        </div>
                        <div class="col-6">
                            <ul class="chart-list-out">
                                <li><span class="circle-blue"></span>Trainer</li>
                                <li><span class="circle-green"></span>Trainee</li>
                                <li class="star-menus"><a href="javascript:;"><i class="fas fa-ellipsis-v"></i></a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="apexcharts-area" style="height: 300px;"></div>
                </div>
            </div>
        </div>
        <div class="col-md-12 col-lg-6">

            <div class="card card-chart">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col-6">
                            <h5 class="card-title">Number of Trainees</h5>
                        </div>
                        <div class="col-6">
                            <ul class="chart-list-out">
                                <li><span class="circle-blue"></span>Girls</li>
                                <li><span class="circle-green"></span>Boys</li>
                                <li class="star-menus"><a href="javascript:;"><i
                                            class="fas fa-ellipsis-v"></i></a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="bar"></div>
                </div>
            </div>

        </div>
    </div>

    <div class="row">
        <div class="col-xl-12 d-flex">

            <div class="card flex-fill student-space comman-shadow">
                <div class="card-header d-flex align-items-center">
                    <h5 class="card-title">Star Trainees for the Presentation</h5>
                </div>
                <div class="card-body">
                    {% comment %} <div class="form-group">
                        <label for="date">Select Presentation Date:</label>
                        <select name="date" id="date" onchange="this.form.submit()" class="form-control">
                            <option value="">-- Select Date --</option>
                            {% for d in available_dates %}
                                <option value="{{ d|date:'Y-m-d' }}" {% if date == d|date:'Y-m-d' %}selected{% endif %}>
                                    {{ d|date:"F j, Y" }}
                                </option>
                            {% endfor %}
                        </select>
                    </div> {% endcomment %}
                    <div class="form-group">
                        <div class="col-12 col-md-8">
                            <label for="date">Select Presentation Date:</label>
                            <select id="date-select" class="form-control form-select">
                                <option value="" disabled selected>Select a date</option>
                                {% for date in dates %}
                                <option value="{{ date|date:'Y-m-d'  }}">{{ date|date:"F j, Y" }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div id="table-star">
                        <p>Loading data...</p>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endif %}
{% endblock main_content %}

{% block custom_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const dateSelect = document.getElementById('date-select');

        dateSelect.addEventListener('change', function () {
            const dateId = this.value;

            if (dateId) {
                fetch(`/get-star_trainee-by-date/${dateId}/`)
                    .then(response => response.json())
                    .then(data => {
                        const tableStar = document.getElementById('table-star');

                        // Ensure the table-star element exists
                        if (!tableStar) {
                            console.error('Element with ID "table-star" not found.');
                            return;
                        }

                        // Sort the presentations array by percentage in descending order
                        data.presentations.sort((a, b) => b.percentage - a.percentage);

                        // Build the table content dynamically
                        let tableContent = `
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table star-student table-hover table-center table-borderless table-striped">
                                        <thead class="thead-light">
                                            <tr>
                                                <th>ID</th>
                                                <th>Name</th>
                                                <th class="text-center">Appearance</th>
                                                <th class="text-center">Content</th>
                                                <th class="text-center">Total</th>
                                                <th class="text-center">Percentage</th>
                                                <th class="text-center">Course</th>
                                                <th class="text-end">View Presentation</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                        `;

                        // Populate the table rows
                        data.presentations.forEach((presentation, index) => {
                            tableContent += `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${presentation.trainee_name}</td>
                                    <td class="text-center">${presentation.score_appearance}</td>
                                    <td class="text-center">${presentation.score_content}</td>
                                    <td class="text-center">${presentation.total_score}</td>
                                    <td class="text-center">${presentation.percentage}%</td>
                                    <td class="text-center">${presentation.course_name}</td>
                                    <td class="text-end"><a href="#">View</a></td>
                                </tr>
                            `;
                        });

                        tableContent += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;

                        // Update the table-star element with the new content
                        tableStar.innerHTML = tableContent;
                    })
                    .catch(error => console.error('Error fetching presentations:', error));
            }
        });
    });
</script>
{% comment %} <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    fetch('/api/trainers-trainees-per-month/')
    .then(response => response.json())
    .then(chartData => {
        console.log(chartData); // Should have months, trainers, trainees arrays

        var options = {
            chart: { type: 'area', height: 300 },
            series: [
                { name: 'Trainers', data: chartData.trainers },
                { name: 'Trainees', data: chartData.trainees }
            ],
            xaxis: {
                categories: chartData.months
            },
            stroke: { curve: 'smooth' },
            colors: ['#007bff', '#28a745'],
            legend: { position: 'top' }
        };

        var chart = new ApexCharts(document.querySelector("#apexchart-area"), options);
        chart.render();
    })
    .catch(error => {
        console.error('Chart error:', error);
    });

});
</script> {% endcomment %}
{% endblock custom_js %}