{% extends "base.html" %}

{% block main_content %}
{% if request.user.user_type == "1" %}
    <div class="page-header">
        <div class="row align-items-center">
            <div class="col">
                <h3 class="page-title"><i class="fas fa-user-plus me-2 text-primary"></i>Add Trainees</h3>
                <ul class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'view_trainee' %}"><i class="fas fa-users me-1"></i>Trainees</a></li>
                    <li class="breadcrumb-item active">Add Trainee</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-12">
            <div class="card shadow-lg border-0">
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data" action="{% url 'add_trainee_save' %}">
                        {% csrf_token %}
                        {% include "includes/messages.html" %}
                        
                        <div class="row">
                            <div class="col-12">
                                <h5 class="form-title"><span>Personal Details</span></h5>
                            </div>
                            
                            <div class="col-12 col-sm-4">
                                <div class="form-group local-forms">
                                    <label>First Name</label>
                                    <input type="text" class="form-control" name="first_name" placeholder="Enter First Name" required>
                                </div>
                            </div>
                            
                            <div class="col-12 col-sm-4">
                                <div class="form-group local-forms">
                                    <label>Middle Name</label>
                                    <input type="text" class="form-control" name="middle_name" placeholder="Enter Middle Name">
                                </div>
                            </div>
                            
                            <div class="col-12 col-sm-4">
                                <div class="form-group local-forms">
                                    <label>Last Name</label>
                                    <input type="text" class="form-control" name="last_name" placeholder="Enter Last Name" required>
                                </div>
                            </div>
                            
                            <div class="col-12 col-sm-4">
                                <div class="form-group local-forms">
                                    <label>Gender</label>
                                    <select name="gender" class="form-control form-select" required>
                                        <option value="" disabled selected>Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-12 col-sm-4">
                                <div class="form-group local-forms">
                                    <label>Mobile Number</label>
                                    <input type="text" class="form-control" name="phone" placeholder="Enter Phone Number" required>
                                </div>
                            </div>
                            
                            <div class="col-12 col-sm-4">
                                <div class="form-group local-forms">
                                    <label>Trainee Category</label>
                                    <select name="category" class="form-control form-select" required>
                                        <option value="" disabled selected>Select Trainee Category</option>
                                        <option value="Regular">Regular Trainee</option>
                                        <option value="SIWES">SIWES Intern</option>
                                        <option value="Extern">Extern</option>
                                        <option value="Triptern">Triptern</option>
                                        <option value="Bootcamp">Bootcamp Kid</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-12 col-sm-4">
                                <div class="form-group local-forms">
                                    <label>Username</label>
                                    <input type="text" class="form-control" name="username" placeholder="Enter Username" required>
                                </div>
                            </div>
                            
                            <div class="col-12 col-sm-4">
                                <div class="form-group local-forms">
                                    <label>Email</label>
                                    <input type="email" class="form-control" name="email" placeholder="Enter Email" required>
                                </div>
                            </div>
                            
                            <div class="col-12 col-sm-4">
                                <div class="form-group local-forms">
                                    <label>Password</label>
                                    <input type="password" class="form-control" name="password1" placeholder="Enter Password" autocomplete required>
                                </div>
                            </div>

                            <center>
                                <div class="col-12 col-sm-6">
                                    <div class="form-group students-up-files">
                                        <label>Upload Profile Photo (150px X 150px)</label>
                                        <div class="uplod">
                                            <label class="file-upload image-upbtn mb-0">
                                                <i class="fas fa-upload me-2"></i>Choose File <input type="file" accept="image/*" name="profile_pic">
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </center>

                            <div class="col-12" id="select-siwes-head" style="display:none;">
                                <h5 class="form-title"><span>SIWES Details</span></h5>
                            </div>

                            <div class="col-12 col-sm-7" id="select-siwes-intern" style="display:none;">
                                <div class="form-group local-forms">
                                    <label>Name of School</label>
                                    <input type="text" class="form-control" name="school_name" placeholder="Enter Name of School">
                                </div>
                            </div>

                            <div class="col-12 col-sm-5" id="select-siwes-intern2" style="display:none;">
                                <div class="form-group local-forms">
                                    <label>Course of Study</label>
                                    <input type="text" class="form-control" name="course_of_study" placeholder="Enter Course of Study">
                                </div>
                            </div>

                            <div class="col-12 col-sm-6" id="select-siwes-intern3" style="display:none;">
                                <div class="form-group local-forms">
                                    <label>Matric Number</label>
                                    <input type="text" class="form-control" name="matric_number" placeholder="Enter Matric Number">
                                </div>
                            </div>

                            <div class="col-12 col-sm-5" id="select-siwes-intern4" style="display:none;">
                                <div class="form-group local-forms">
                                    <label>Duration of Internship</label>
                                    <input type="text" class="form-control" name="internship_duration" placeholder="Enter Duration of Internship">
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <h5 class="form-title"><span>Address Information</span></h5>
                            </div>
                            
                            <div class="col-12 col-sm-4">
                                <div class="form-group local-forms">
                                    <label>City</label>
                                    <input type="text" class="form-control" name="city" placeholder="Enter City" required>
                                </div>
                            </div>
                            
                            <div class="col-12 col-sm-4">
                                <div class="form-group local-forms">
                                    <label>State</label>
                                    <input type="text" class="form-control" name="state" placeholder="Enter State" required>
                                </div>
                            </div>
                            
                            <div class="col-12 col-sm-4">
                                <div class="form-group local-forms">
                                    <label>Country</label>
                                    <input type="text" class="form-control" name="country" placeholder="Enter Country" required>
                                </div>
                            </div>

                            <div class="col-12 col-sm-6">
                                <div class="form-group local-forms">
                                    <label>Address</label>
                                    <textarea class="form-control" name="address" placeholder="Enter Full Address" rows="3" required></textarea>
                                </div>
                            </div>
                            
                            <!-- Course Selection Section -->
                            <div class="col-12">
                                <h5 class="form-title"><span>Course and Payment Option Selection</span></h5>
                            </div>
                            
                            <div class="col-12 col-sm-8">
                                <div class="form-group local-forms">
                                    <label>Select Course</label>
                                    <select name="course" class="form-control form-select" required>
                                        <option value="" selected disabled>Select a Course you would like to Study</option>
                                        {% for course in courses %}
                                            <option value="{{ course.id }}">{{ course.course_name }} - ₦{{ course.price }}</option>
                                        {% endfor %}
                                    </select> 
                                </div>
                            </div>

                            <div class="col-12 col-sm-8">
                                <div class="form-group local-forms">
                                    <label>Course Portion</label>
                                    <select name="portion_type" id="portion_type" class="form-control form-select" required>
                                        <option value="Full Course" selected>Full Course</option>
                                        <option value="Level">Specific Level(s)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-12 col-sm-8" id="portion-value-section" style="display:none;">
                                <div class="form-group" id="portion-value-container" name="portion_value_container">
                                    <!-- Content will be injected by JS -->
                                </div>
                            </div>

                            <div class="col-12 col-sm-8">
                                <div class="form-group local-forms">
                                    <label>Payment Option</label>
                                    <select name="payment" class="form-control form-select" required>
                                        <option value="" disabled selected>Select Payment Option</option>
                                        <option value="Full Payment">Full Payment</option>
                                        <option value="70% upfront and 30% later">70% upfront and 30% later</option>
                                        <option value="Monthly Payment">Monthly Payment</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-12 col-sm-6">
                                <div class="form-group local-forms">
                                    <label>Amount Paid</label>
                                    <input type="number" name="amount_paid" class="form-control" placeholder="Amount Paid" required>
                                </div>
                            </div>

                            <div class="col-12 col-sm-6">
                                <div class="form-group local-forms">
                                    <label>Date of Payment</label>
                                    <input type="date" name="date_of_payment" class="form-control" placeholder="Select Date of Payment" required>
                                </div>
                            </div>

                            <div class="col-12 col-sm-5">
                                <div class="form-group local-forms">
                                    <label>Payment Method</label>
                                    <select name="payment_method" class="form-control form-select" required>
                                        <option value="" disabled selected>Select Payment Method</option>
                                        <option value="Cash">Cash</option>
                                        <option value="Bank Transfer">Bank Transfer</option>
                                        <option value="Card">Card</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-12 col-sm-5" id="installment-section" style="display:none;">
                                <div class="form-group local-forms">
                                    <label>Installmental Payment</label>
                                    <select name="installmental_payment" id="installmental_payment" class="form-control form-select">
                                        <option value="" disabled selected>Select Installment</option>
                                        <!-- Options will be populated by JS -->
                                    </select>
                                </div>
                            </div>

                            <div class="col-12 col-sm-6" id="due-date-section" style="display:none;">
                                <div class="form-group local-forms">
                                    <label>Due Date for Remaining 30%</label>
                                    <input type="date" name="due_date_30" class="form-control" placeholder="Select Due Date">
                                    <span class="fw-bold text-danger"><small id="remaining-amount-info" name="upfront_due_date" class="form-text text-muted"></small></span>
                                </div>
                            </div>

                            <div class="col-12 col-sm-7">
                                <div class="form-group local-forms">
                                    <label>Commencement Date</label>
                                    <input type="date" class="form-control" name="commencement_date" placeholder="Enter Country" required>
                                </div>
                            </div>

                            <div class="col-12">
                                <h5 class="form-title"><span>Next of Kin</span></h5>
                            </div>

                            <div class="col-12 col-sm-4">
                                <div class="form-group local-forms">
                                    <label>First Name</label>
                                    <input type="text" name="next_first_name" class="form-control" placeholder="Enter Full Name" required>
                                </div>
                            </div>

                            <div class="col-12 col-sm-4">
                                <div class="form-group local-forms">
                                    <label>Last Name</label>
                                    <input type="text" name="next_last_name" class="form-control" placeholder="Enter Full Name" required>
                                </div>
                            </div>

                            <div class="col-12 col-sm-4">
                                <div class="form-group local-forms">
                                    <label>Email</label>
                                    <input type="email" name="next_email" class="form-control" placeholder="Enter Email" required>
                                </div>
                            </div>
                            
                            <div class="col-12 col-sm-5">
                                <div class="form-group local-forms">
                                    <label>Phone</label>
                                    <input type="text" name="next_phone" class="form-control" placeholder="Enter Phone Number" required>
                                </div>
                            </div>
                            

                            <div class="col-12 col-sm-6">
                                <div class="form-group local-forms">
                                    <label>Relation</label>
                                    <input type="text" name="relation" class="form-control" placeholder="Enter Relationship" required>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="col-12">
                                <div class="student-submit">
                                    <button type="submit" class="btn btn-primary">Add Trainee</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // DOM elements
    const courseSelect = document.querySelector('select[name="course"]');
    const paymentSelect = document.querySelector('select[name="payment"]');
    const amountPaidInput = document.querySelector('input[name="amount_paid"]');
    const installmentSection = document.getElementById('installment-section');
    const installmentSelect = document.getElementById('installmental_payment');
    const dueDateSection = document.getElementById('due-date-section');
    const remainingAmountInfo = document.getElementById('remaining-amount-info');
    const traineeCategorySelect = document.querySelector('select[name="category"]');
    const siwesSectionHead = document.getElementById('select-siwes-head');
    const siwesSection = document.getElementById('select-siwes-intern');
    const siwesSection2 = document.getElementById('select-siwes-intern2');
    const siwesSection3 = document.getElementById('select-siwes-intern3');
    const siwesSection4 = document.getElementById('select-siwes-intern4');
    const portionTypeSelect = document.getElementById('portion_type');
    const portionValueSection = document.getElementById('portion-value-section');
    const portionValueContainer = document.getElementById('portion-value-container');

    // Payment info panel
    let paymentInfo = document.createElement('div');
    paymentInfo.id = 'payment-info';
    paymentInfo.className = 'alert alert-info mt-3';
    paymentInfo.style.display = 'none';
    const paymentFormGroup = paymentSelect.closest('.form-group');
    if (paymentFormGroup) paymentFormGroup.appendChild(paymentInfo);

    // course data (from Django context)
    let courseData = {};
    {% for course in courses %}
        courseData["{{ course.id }}"] = {
            price: {{ course.price|floatformat:2 }},
            months: {{ course.months|default:1 }}
        };
    {% endfor %}

    function formatCurrency(amount) {
        return '₦' + Number(amount).toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function getLevelCheckboxes() {
        return Array.from(portionValueContainer.querySelectorAll('.level-checkbox'));
    }

    function getSelectedLevelsCount() {
        const boxes = getLevelCheckboxes();
        return boxes.filter(b => b.checked).length;
    }

    function getTotalLevelsCount() {
        return getLevelCheckboxes().length;
    }

    // Compute effective price and months depending on Full vs Level selection
    function getSelectedPriceAndMonths() {
        const courseId = courseSelect.value;
        const course = courseData[courseId];
        if (!course) return { price: 0, months: 1 };

        if (portionTypeSelect.value === 'Level') {
            const totalLevels = getTotalLevelsCount();
            const selectedLevels = getSelectedLevelsCount();
            if (totalLevels > 0 && selectedLevels > 0) {
                const perLevelPrice = course.price / totalLevels;
                return {
                    price: perLevelPrice * selectedLevels,
                    months: selectedLevels
                };
            }
            // nothing selected -> price 0
            return { price: 0, months: 1 };
        }

        return { price: course.price, months: course.months || 1 };
    }

    // Populate installment options for monthly payment
    function updateInstallmentOptions() {
        const paymentOption = paymentSelect.value;
        const { months } = getSelectedPriceAndMonths();
        installmentSelect.innerHTML = '<option value="" disabled selected>Select Installment</option>';
        installmentSection.style.display = 'none';

        if (paymentOption === 'Monthly Payment') {
            if (!months || months <= 1) {
                installmentSection.style.display = 'none';
                // disable Monthly Payment option visually
                const monthlyOpt = paymentSelect.querySelector('option[value="Monthly Payment"]');
                if (monthlyOpt) monthlyOpt.disabled = true;
            } else {
                const monthlyOpt = paymentSelect.querySelector('option[value="Monthly Payment"]');
                if (monthlyOpt) monthlyOpt.disabled = false;
                for (let i = 1; i <= months; i++) {
                    let suffix = 'th';
                    if (i === 1) suffix = 'st';
                    else if (i === 2) suffix = 'nd';
                    else if (i === 3) suffix = 'rd';
                    installmentSelect.insertAdjacentHTML('beforeend', `<option value="${i}">${i}${suffix} Installment</option>`);
                }
                installmentSection.style.display = 'block';

                // Try preserve previously selected installment if present
                const prev = installmentSelect.getAttribute('data-selected');
                if (prev) installmentSelect.value = prev;
            }
        } else {
            const monthlyOpt = paymentSelect.querySelector('option[value="Monthly Payment"]');
            if (monthlyOpt) monthlyOpt.disabled = false;
        }
    }

    // Show due-date + remaining amount for 70/30 option
    function updateDueDateSection() {
        const paymentOption = paymentSelect.value;
        const { price } = getSelectedPriceAndMonths();
        dueDateSection.style.display = 'none';
        remainingAmountInfo.innerHTML = '';

        if (paymentOption !== '70% upfront and 30% later' || price <= 0) {
            return;
        }

        const paid = parseFloat(amountPaidInput.value) || 0;
        const upfront = Math.round(price * 0.7 * 100) / 100;
        const later = Math.round((price - upfront) * 100) / 100;
        let text = '';

        if (paid < upfront) {
            const remaining_upfront = Math.round((upfront - paid) * 100) / 100;
            text += `<div><strong>Total for selection:</strong> ${formatCurrency(price)}</div>`;
            text += `<div><strong>Required upfront (70%):</strong> ${formatCurrency(upfront)} — you still owe <span class="fw-bold text-danger">${formatCurrency(remaining_upfront)}</span> upfront.</div>`;
            text += `<div><strong>Remaining 30% due later:</strong> ${formatCurrency(later)}</div>`;
        } else {
            // upfront paid (or overpaid). compute remaining overall
            const remaining_total = Math.max(0, Math.round((price - paid) * 100) / 100);
            text += `<div><strong>Upfront (70%) paid.</strong></div>`;
            text += `<div><strong>Remaining amount to be paid later:</strong> ${formatCurrency(remaining_total)}</div>`;
        }

        remainingAmountInfo.innerHTML = text;
        dueDateSection.style.display = 'block';
    }

    // Build and show payment info panel (Full / Level + breakdowns)
    function updatePaymentInfo() {
        const paymentOption = paymentSelect.value;
        const { price, months } = getSelectedPriceAndMonths();

        paymentInfo.innerHTML = '';
        paymentInfo.style.display = 'none';

        if (price <= 0 || !paymentOption) return;

        if (portionTypeSelect.value === 'Level') {
            const selectedLevels = getSelectedLevelsCount();
            const totalLevels = getTotalLevelsCount();
            const perLevelPrice = selectedLevels ? (price / selectedLevels) : 0;

            let html = '<div class="mb-2"><span class="badge bg-primary">Level Selection</span></div>';
            html += `<div><strong>Selected Levels:</strong> ${selectedLevels} of ${totalLevels}</div>`;
            html += `<div><strong>Price per selected level:</strong> ${formatCurrency(perLevelPrice)}</div>`;
            html += `<div><strong>Total for selected levels:</strong> <span class="fw-bold text-success">${formatCurrency(price)}</span></div>`;

            if (paymentOption === 'Full Payment') {
                html += `<div class="mt-2"><strong>Full Payment:</strong> Pay ${formatCurrency(price)} now.</div>`;
            } else if (paymentOption === '70% upfront and 30% later') {
                const upfront = Math.round(price * 0.7 * 100) / 100;
                const later = Math.round((price - upfront) * 100) / 100;
                html += `<div class="mt-2"><strong>70% Upfront:</strong> ${formatCurrency(upfront)} — <strong>30% Later:</strong> ${formatCurrency(later)}</div>`;
            } else if (paymentOption === 'Monthly Payment') {
                const monthly = months ? (price / months) : price;
                html += `<div class="mt-2"><strong>Monthly Payment:</strong> ${formatCurrency(monthly)} per month for <strong>${months}</strong> month(s). Total ${formatCurrency(price)}</div>`;
            }

            paymentInfo.innerHTML = html;
            paymentInfo.style.display = 'block';
        } else {
            // Full-course logic (unchanged)
            if (paymentOption === 'Full Payment') {
                paymentInfo.innerHTML = `<i class="fas fa-money-bill-wave"></i> <strong>Full Payment:</strong> The total amount to be paid is <span class="fw-bold text-success">${formatCurrency(price)}</span>.`;
            } else if (paymentOption === '70% upfront and 30% later') {
                const upfront = Math.round(price * 0.7 * 100) / 100;
                const later = Math.round((price - upfront) * 100) / 100;
                paymentInfo.innerHTML = `<i class="fas fa-coins"></i> <strong>70% Upfront:</strong> ${formatCurrency(upfront)} — <strong>30% Later:</strong> ${formatCurrency(later)}.`;
            } else if (paymentOption === 'Monthly Payment') {
                const monthly = months ? (price / months) : price;
                paymentInfo.innerHTML = `<i class="fas fa-calendar-alt"></i> <strong>Monthly:</strong> ${formatCurrency(monthly)} per month for <strong>${months}</strong> month(s). Total ${formatCurrency(price)}.`;
            }
            paymentInfo.style.display = 'block';
        }
    }

    function updateLevelPrice() {
        updatePaymentInfo();
        updateInstallmentOptions();
        updateDueDateSection();
    }

    // load levels via AJAX and pre-check if editing (this template supports add/edit reuse)
    portionTypeSelect.addEventListener('change', function() {
        const val = this.value;
        portionValueSection.style.display = (val === 'Level') ? 'block' : 'none';
        portionValueContainer.innerHTML = '';

        if (val === 'Level') {
            portionValueContainer.innerHTML = '<label>Select Level(s)</label><div id="level-loading">Loading...</div>';
            const courseId = courseSelect.value;
            if (!courseId) {
                portionValueContainer.innerHTML = '<label>Select Level(s)</label><div class="text-warning">Please select a course first.</div>';
                return;
            }

            fetch(`/ajax/get-levels/?course_id=${courseId}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.levels || data.levels.length === 0) {
                        portionValueContainer.innerHTML = '<label>Select Level(s)</label><div class="text-danger">No levels available for this course.</div>';
                        return;
                    }

                    let html = '<label class="mb-2">Select Level(s)</label>';
                    html += '<div class="row" id="levels-checkbox-group">';
                    data.levels.forEach(level => {
                        html += `
                            <div class="col-12 col-md-6 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input level-checkbox" type="checkbox" name="portion_value" id="level_${level.id}" value="${level.id}">
                                    <label class="form-check-label" for="level_${level.id}">${level.name || level.level}</label>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    html += '<small class="form-text text-muted">Select one or more levels, but not all.</small>';
                    html += '<div id="level-warning" class="text-danger mt-2" style="display:none;">You cannot select all levels. Please select fewer levels or choose "Full Course".</div>';
                    portionValueContainer.innerHTML = html;

                    // attach listeners
                    const checkboxes = portionValueContainer.querySelectorAll('.level-checkbox');
                    const warning = portionValueContainer.querySelector('#level-warning');
                    checkboxes.forEach(cb => {
                        cb.addEventListener('change', function() {
                            const checked = Array.from(checkboxes).filter(c => c.checked);
                            if (checked.length === checkboxes.length) {
                                this.checked = false;
                                warning.style.display = 'block';
                            } else {
                                warning.style.display = 'none';
                            }
                            updateLevelPrice();
                        });
                    });

                    // initial update
                    updateLevelPrice();
                })
                .catch(() => {
                    portionValueContainer.innerHTML = '<label>Select Level(s)</label><div class="text-danger">Error loading levels.</div>';
                });
        } else {
            updatePaymentInfo();
            updateInstallmentOptions();
            updateDueDateSection();
        }
    });

    // event wiring
    courseSelect.addEventListener('change', function() {
        if (portionTypeSelect.value === 'Level') portionTypeSelect.dispatchEvent(new Event('change'));
        updatePaymentInfo();
        updateInstallmentOptions();
        updateDueDateSection();
    });

    paymentSelect.addEventListener('change', function() {
        updatePaymentInfo();
        updateInstallmentOptions();
        updateDueDateSection();
    });

    amountPaidInput.addEventListener('input', function() {
        updateDueDateSection();
        updatePaymentInfo();
    });

    // SIWES toggles
    traineeCategorySelect.addEventListener('change', function() {
        const show = traineeCategorySelect.value === 'SIWES';
        siwesSectionHead.style.display = show ? 'block' : 'none';
        siwesSection.style.display = show ? 'block' : 'none';
        siwesSection2.style.display = show ? 'block' : 'none';
        siwesSection3.style.display = show ? 'block' : 'none';
        siwesSection4.style.display = show ? 'block' : 'none';
    });
    const showSiwes = traineeCategorySelect.value === 'SIWES';
    siwesSectionHead.style.display = showSiwes ? 'block' : 'none';
    siwesSection.style.display = showSiwes ? 'block' : 'none';
    siwesSection2.style.display = showSiwes ? 'block' : 'none';
    siwesSection3.style.display = showSiwes ? 'block' : 'none';
    siwesSection4.style.display = showSiwes ? 'block' : 'none';

    // helper: attach listeners to dynamically added level checkboxes when they exist
    function attachLevelListenersAfterLoad() {
        setTimeout(() => {
            const boxes = document.querySelectorAll('.level-checkbox');
            if (boxes.length) {
                boxes.forEach(b => b.addEventListener('change', () => {
                    updateLevelPrice();
                }));
            }
        }, 200);
    }
    portionTypeSelect.addEventListener('change', attachLevelListenersAfterLoad);
    courseSelect.addEventListener('change', attachLevelListenersAfterLoad);

    // initial state
    updateInstallmentOptions();
    updateDueDateSection();
    updatePaymentInfo();
});
</script>
{% endif %}
{% endblock main_content %}