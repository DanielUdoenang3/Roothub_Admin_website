{% extends "base.html" %}
{% load static %}
{% block main_content %}

{% if request.user.user_type == "1" %}

<div class="page-header">
    <div class="row align-items-center">
        <div class="col">
            <h3 class="page-title"><i class="fas fa-user-plus me-2 text-primary"></i>Assign Trainee</h3>
            <ul class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'view_trainee' %}"><i class="fas fa-users me-1"></i>Trainees</a></li>
                <li class="breadcrumb-item active">Assign Trainee</li>
            </ul>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-sm-12">
        <div class="card shadow-lg border-0">
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    {% include "includes/messages.html" %}
                    <div class="row">
                        <div class="col-12">
                            <h5 class="form-title"><span>Assign Trainee to a Course</span></h5>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="form-group local-forms">
                                <label for="trainee-select">Select Trainee</label>
                                <select class="form-control form-select" name="trainee" id="trainee-select" required>
                                    <option disabled selected hidden>Select Trainee</option>
                                    {% for trainee in trainees %}
                                        <option value="{{ trainee.id }}">{{ trainee.trainee_name.first_name }} {{ trainee.trainee_name.last_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="form-group local-forms">
                                <label for="course-select">Course Intended</label>
                                <input type="text" class="form-control" id="course-name" name="course_name" readonly placeholder="Course will appear here">
                                <input type="hidden" name="course" id="course-id">
                            </div>
                        </div>
                        <div class="col-12">
                            <div id="levels-section"></div>
                        </div>
                        <div class="col-12">
                            <div id="trainers-by-level-container"></div>
                        </div>
                        <div class="col-12">
                            <div id="assignment-summary" class="mb-3"></div>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary btn-lg w-100"><i class="fas fa-plus me-2"></i>Assign Trainee</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const traineeSelect = document.getElementById('trainee-select');
        const courseNameInput = document.getElementById('course-name');
        const courseIdInput = document.getElementById('course-id');
        const trainerSelect = document.getElementById('trainer-select');
        // Card-style multi-select for levels
        let levelsData = [];
        const levelsSection = document.getElementById('levels-section');
        const trainersByLevelContainer = document.getElementById('trainers-by-level-container');
        const assignmentSummary = document.getElementById('assignment-summary');
        const form = document.querySelector('form');
        const submitBtn = form.querySelector('button[type="submit"]');

        // Reset fields
        function resetFields() {
            courseNameInput.value = '';
            courseIdInput.value = '';
            levelsData = [];
            levelsSection.innerHTML = '';
            trainersByLevelContainer.innerHTML = '';
            assignmentSummary.innerHTML = '';
        }

        // Fetch course for trainee
        traineeSelect.addEventListener('change', function() {
            resetFields();
            const traineeId = this.value;
            if (!traineeId) return;
            courseNameInput.value = 'Loading...';
            fetch(`/get_trainee_course/${traineeId}/`)
                .then(res => res.json())
                .then(data => {
                    if (data.id && data.name) {
                        courseNameInput.value = data.name;
                        courseIdInput.value = data.id;
                        loadLevels(data.id);
                    } else {
                        courseNameInput.value = 'No course found';
                    }
                })
                .catch(() => {
                    courseNameInput.value = 'Error fetching course';
                });
        });

        // Load levels for course
        function loadLevels(courseId) {
            levelsSection.innerHTML = '<div class="text-center py-2"><span class="spinner-border spinner-border-sm text-primary"></span> Loading levels...</div>';
            fetch(`/get_course_levels/${courseId}/`)
                .then(res => res.json())
                .then(data => {
                    levelsData = data.levels;
                    if (levelsData.length === 0) {
                        levelsSection.innerHTML = '<div class="alert alert-warning">No levels found</div>';
                    } else {
                        renderLevelCards();
                    }
                })
                .catch(() => {
                    levelsSection.innerHTML = '<div class="alert alert-danger">Error loading levels</div>';
                });
        }

        // Render card-style selector for levels
        function renderLevelCards() {
            levelsSection.innerHTML = '';
            const row = document.createElement('div');
            row.className = 'row';
            levelsData.forEach(level => {
                const col = document.createElement('div');
                col.className = 'col-md-4 mb-3';
                const card = document.createElement('div');
                card.className = 'card border-0 shadow-sm h-100';
                card.innerHTML = `<div class="card-body d-flex align-items-center">
                    <input class="form-check-input me-2" type="checkbox" id="level_${level.id}" value="${level.id}">
                    <label class="form-check-label w-100" for="level_${level.id}">
                        <i class="fas fa-layer-group me-1 text-primary"></i>
                        <span class="fw-bold">${level.name}</span>
                    </label>
                </div>`;
                card.querySelector('input').addEventListener('change', updateSelectedLevels);
                col.appendChild(card);
                row.appendChild(col);
            });
            levelsSection.appendChild(row);
        }

        // Update trainer display and assignment summary
        function updateSelectedLevels() {
            const selected = Array.from(levelsSection.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            showTrainersForLevels(selected);
            updateAssignmentSummary(selected);
        }

        function updateAssignmentSummary(selectedLevels) {
            if (!selectedLevels.length) {
                assignmentSummary.innerHTML = '';
                return;
            }
            const selectedNames = selectedLevels.map(lid => {
                const levelObj = levelsData.find(l => l.id == lid);
                return levelObj ? `<span class='badge bg-primary me-2'>${levelObj.name}</span>` : '';
            }).join(' ');
            assignmentSummary.innerHTML = `<div class='alert alert-info'><i class='fas fa-info-circle me-2'></i>Selected Levels: ${selectedNames}</div>`;
        }

        // When levels are selected, fetch trainers for each level
        // Show trainers for selected levels in a modern card grid
        function showTrainersForLevels(selectedLevels) {
            const courseId = courseIdInput.value;
            trainersByLevelContainer.innerHTML = '';
            if (!courseId || selectedLevels.length === 0) return;
            trainersByLevelContainer.innerHTML = '<div class="text-center py-3"><span class="spinner-border text-primary" role="status"></span> Loading trainers for selected levels...</div>';
            fetch(`/get_trainers_for_levels/${courseId}/?` + selectedLevels.map(lid => `level_ids[]=${lid}`).join('&'))
                .then(res => res.json())
                .then(data => {
                    trainersByLevelContainer.innerHTML = '';
                    const trainersByLevel = data.trainers_by_level;
                    selectedLevels.forEach(levelId => {
                        const trainers = trainersByLevel[levelId] || [];
                        const levelObj = levelsData.find(l => l.id == levelId);
                        const levelName = levelObj ? levelObj.name : 'Level';
                        const card = document.createElement('div');
                        card.className = 'card mb-4 border-0 shadow-sm';
                        card.innerHTML = `<div class="card-header bg-gradient bg-primary text-white d-flex align-items-center justify-content-between">
                            <span><i class="fas fa-layer-group me-2"></i><strong>${levelName}</strong></span>
                            <span class="badge bg-success">Select Trainer</span>
                        </div>`;
                        const body = document.createElement('div');
                        body.className = 'card-body row';
                        if (trainers.length === 0) {
                            body.innerHTML = '<div class="col-12"><div class="alert alert-warning">No trainers found for this level.</div></div>';
                        } else {
                            trainers.forEach(trainer => {
                                const radioId = `trainer_for_level_${levelId}_${trainer.id}`;
                                const avatar = `<span class="avatar bg-primary text-white rounded-circle me-2" style="width:32px;height:32px;display:inline-flex;align-items:center;justify-content:center;font-weight:bold;">${trainer.name.split(' ')[0][0]}</span>`;
                                const radio = `<div class="col-md-6 mb-3">
                                    <div class="card border-0 shadow-sm h-100">
                                        <div class="card-body d-flex align-items-center">
                                            <input class="form-check-input me-2" type="radio" name="trainer_for_level_${levelId}" id="${radioId}" value="${trainer.id}" required>
                                            <label class="form-check-label w-100" for="${radioId}">
                                                ${avatar}
                                                <span class="fw-bold">${trainer.name}</span>
                                                <span class="badge bg-info ms-2">Trainer</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>`;
                                body.innerHTML += radio;
                            });
                        }
                        card.appendChild(body);
                        trainersByLevelContainer.appendChild(card);
                    });
                })
                .catch(() => {
                    trainersByLevelContainer.innerHTML = '<div class="alert alert-danger">Error loading trainers for levels.</div>';
                });
        }

        // Professional UX: show loading spinner on submit
        form.addEventListener('submit', function() {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Assigning...';
        });
    });
</script>
{% else %}
    <div class="alert alert-danger text-center">
        <h4 class="alert-heading">Access Denied!</h4>
        <p>You do not have permission to access this page.</p>
        <hr>
        <p class="mb-0">Please contact the administrator if you believe this is an error.</p>
    </div>
{% endif %}
{% endblock main_content %}